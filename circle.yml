--- 
machine:
  services:
    - docker
dependencies: 
  cache_directories:
    - '~/.rvm/rubies'
    - 'vendor'
  override: 
    - |
        case $CIRCLE_NODE_INDEX in
         0) export RVM=1.9.3-p448
           rvm use ruby-${RVM}
           PUPPET_GEM_VERSION="~> 3.0" rvm-exec $RVM bash -c "bundle install --path=vendor/bundle_${CIRCLE_NODE_INDEX}"
           ;;
         1) export RVM=2.1.5
           rvm use ruby-${RVM}
           PUPPET_GEM_VERSION="~> 3.0" rvm-exec $RVM bash -c "bundle install --path=vendor/bundle_${CIRCLE_NODE_INDEX}"
           ;;
         2) export RVM=2.1.6
           rvm use ruby-${RVM}
           PUPPET_GEM_VERSION="~> 4.0" rvm-exec $RVM bash -c "bundle install --path=vendor/bundle_${CIRCLE_NODE_INDEX}"
           ;;
         3) bundle install --path=vendor/bundle_${CIRCLE_NODE_INDEX} --without development
           ;;
        esac
deployment: 
  bugfix: 
    branch: /^bugfix.*/
    commands: 
      - "./scripts/circle.bash merge release/patch"
  improvement: 
    branch: /^improvement.*/
    commands: 
      - "./scripts/circle.bash merge release/patch"
  master: 
    branch: master
    commands: 
      - "./scripts/circle.bash merge release/latest"
      - "./scripts/circle.bash deploy"
  patch_release:
    branch: release/patch
    commands:
      - "./scripts/circle.bash merge release/minor"
notify: 
  webhooks: 
    - 
      url: "https://webhooks.gitter.im/e/da8c065419a91983f0cf"
test: 
  override: 
    - 
      ? "case $CIRCLE_NODE_INDEX in 0) RVM=1.9.3-p551 rvm-exec 1.9.3-p551 ./scripts/circle.bash unit_tests ;; 1) RVM=2.1.5 rvm-exec 2.1.5 ./scripts/circle.bash unit_tests ;; 2) RVM=2.1.6 rvm-exec 2.1.6 ./scripts/circle.bash unit_tests ;; 3) bundle exec rake rubocop ;; esac"
      : 
        parallel: true
    - ./scripts/circle.bash acceptance_tests circle_debian7:
        timeout: 300
        parallel: true
    - ./scripts/circle.bash acceptance_tests circle_ubuntu14:
        timeout: 300
        parallel: true
